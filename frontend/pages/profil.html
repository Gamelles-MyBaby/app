<link rel="stylesheet" href="pages/profil.css">

<div class="profile-container">
  <div class="profile-grid">
    <!-- Sidebar: Basic Info -->
    <aside class="profile-sidebar">
      <div class="card glass-card">
        <div class="avatar-header">
          <img id="display-avatar" src="https://ui-avatars.com/api/?name=User&background=random&color=fff&size=128"
            alt="Avatar">
          <div id="display-pseudo" class="pseudo">Chargement...</div>
          <div id="display-role" class="role-tag">Joueur</div>
        </div>

        <div class="stats-overview">
          <div class="stat-pill">
            <span class="stat-val" id="stat-elo">...</span>
            <span class="stat-lbl">Points ELO</span>
          </div>
        </div>

        <div class="menu-list">
          <button class="menu-item active">üë§ Informations</button>
          <button id="btnSettings" class="menu-item">‚öôÔ∏è Param√®tres</button>
          <button id="btnLogout" class="menu-item logout">üö™ D√©connexion</button>
        </div>
      </div>
    </aside>

    <!-- Main Content: Details & Babyfoots -->
    <main class="profile-main">
      <section class="card">
        <h2 style="margin-top:0">D√©tails du compte</h2>
        <div class="info-grid">
          <div class="info-box">
            <label>Adresse Email</label>
            <div id="display-email">...</div>
          </div>
          <div class="info-box">
            <label>Date d'inscription</label>
            <div id="display-date">...</div>
          </div>
        </div>
      </section>

      <section class="card" style="margin-top:24px">
        <h2 style="margin-top:0">Statistiques de Jeu</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <label>Matchs Jou√©s</label>
            <div id="stat-parties">0</div>
          </div>
          <div class="stat-card win">
            <label>Victoires</label>
            <div id="stat-victoires">0</div>
          </div>
          <div class="stat-card loss">
            <label>D√©faites</label>
            <div id="stat-defaites">0</div>
          </div>
          <div class="stat-card">
            <label>ELO Min / Max</label>
            <div id="stat-elo-range">1500 / 1500</div>
          </div>
          <div class="stat-card streak">
            <label>S√©rie Actuelle</label>
            <div id="stat-streak-now">0</div>
          </div>
          <div class="stat-card streak-max">
            <label>S√©rie Max</label>
            <div id="stat-streak-max">0</div>
          </div>
        </div>
      </section>

      <section class="card" style="margin-top:24px">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
          <h2 style="margin:0">Mes Babyfoots</h2>
          <button id="btnAddBabyfoot" class="btn primary">Ôºã Ajouter</button>
        </div>
        <div id="babyfoot-list" class="bars-list">
          <div class="loader-sm">R√©cup√©ration...</div>
        </div>
      </section>
    </main>
  </div>
</div>

<style>
  .profile-grid {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 32px;
  }

  .glass-card {
    background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  .avatar-header {
    text-align: center;
    padding: 20px 0;
  }

  #display-avatar {
    width: 120px;
    height: 120px;
    border-radius: 30px;
    object-fit: cover;
    border: 4px solid #fff;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    margin-bottom: 15px;
  }

  .pseudo {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--gris-fonce);
  }

  .role-tag {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--rouge);
    font-weight: 700;
    margin-top: 5px;
  }

  .stats-overview {
    display: flex;
    justify-content: center;
    margin: 20px 0;
  }

  .stat-pill {
    background: #fff;
    padding: 12px 24px;
    border-radius: 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    text-align: center;
  }

  .stat-val {
    display: block;
    font-size: 1.4rem;
    font-weight: 800;
    color: var(--rouge);
  }

  .stat-lbl {
    font-size: 0.7rem;
    color: #999;
    text-transform: uppercase;
  }

  .menu-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 20px;
  }

  .menu-item {
    background: transparent;
    border: none;
    padding: 12px 16px;
    border-radius: 12px;
    text-align: left;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    color: #666;
  }

  .menu-item:hover {
    background: #fff;
    transform: translateX(5px);
  }

  .menu-item.active {
    background: var(--rouge);
    color: #fff;
  }

  .menu-item.logout:hover {
    color: var(--rouge);
  }

  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 15px;
  }

  .info-box {
    background: #fdfdfd;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #f0f0f0;
  }

  .info-box label {
    display: block;
    font-size: 0.75rem;
    color: #999;
    margin-bottom: 5px;
    text-transform: uppercase;
  }

  .info-box div {
    font-weight: 700;
    color: var(--gris-fonce);
  }

  .bar-item-p {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #eee;
  }

  .bar-item-p:last-child {
    border: none;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-top: 15px;
  }

  .stat-card {
    background: #fdfdfd;
    padding: 16px;
    border-radius: 12px;
    border: 1px solid #f0f0f0;
    text-align: center;
  }

  .stat-card label {
    display: block;
    font-size: 0.7rem;
    color: #999;
    text-transform: uppercase;
    margin-bottom: 8px;
    font-weight: 600;
  }

  .stat-card div {
    font-size: 1.2rem;
    font-weight: 800;
    color: var(--gris-fonce);
  }

  .stat-card.win div {
    color: #2ecc71;
  }

  .stat-card.loss div {
    color: #e74c3c;
  }

  .stat-card.streak div {
    color: #f1c40f;
  }

  .stat-card.streak-max div {
    color: #f39c12;
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: 1fr 1fr;
    }

    .profile-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script type="module">
  import { userService } from './services/userService.js';
  import { babyfootService } from './services/babyfootService.js';

  (async function () {
    'use strict';

    const rawUser = localStorage.getItem('mybaby_user');
    if (!rawUser) {
      window.location.hash = '#login';
      return;
    }

    const user = JSON.parse(rawUser);
    const uid = user.id_utilisateur || user.id;

    async function loadProfile() {
      try {
        const profile = await userService.getProfile(uid);
        document.getElementById('display-pseudo').textContent = profile.pseudo;
        document.getElementById('display-email').textContent = profile.email || 'Non renseign√©';
        document.getElementById('display-date').textContent = profile.date_inscription ? new Date(profile.date_inscription).toLocaleDateString() : 'Inconnue';
        document.getElementById('stat-elo').textContent = profile.elo_score || 1500;
        document.getElementById('display-role').textContent = "Compte " + (profile.role || 'joueur');
        document.getElementById('display-avatar').src = profile.photo_profil || `https://ui-avatars.com/api/?name=${profile.pseudo}&background=random&color=fff&size=128`;

        // Extended Stats
        document.getElementById('stat-parties').textContent = profile.nombre_parties || 0;
        document.getElementById('stat-victoires').textContent = profile.nombre_victoires || 0;
        document.getElementById('stat-defaites').textContent = profile.nombre_defaites || 0;
        document.getElementById('stat-elo-range').textContent = `${profile.elo_min || 1500} / ${profile.elo_max || 1500}`;
        document.getElementById('stat-streak-now').textContent = profile.serie_victoires_actuelle || 0;
        document.getElementById('stat-streak-max').textContent = profile.serie_victoires_max || 0;

      } catch (err) {
        console.error("Profile load err:", err);
        // If 401/404, maybe session is dead
        if (err.message.includes('40')) {
          localStorage.removeItem('mybaby_user');
          window.location.hash = '#login';
        }
      }
    }

    async function loadMyBabyfoots() {
      const listContainer = document.getElementById('babyfoot-list');
      try {
        const data = await babyfootService.getAllBabyfoots();
        // Use loose equality for safety with potential string/num mismatch, though both should be nums now
        const myBars = data.filter(b => b.id_utilisateur == uid);

        if (myBars.length > 0) {
          listContainer.innerHTML = myBars.map(b => `
                        <div class="bar-item-p">
                            <div>
                                <div style="font-weight:700">${b.nom_lieu}</div>
                                <small style="color:#999">${b.adresse || b.ville}</small>
                            </div>
                            <span class="badge" style="background:#f0f0f0; padding:4px 10px; border-radius:8px; font-size:0.8rem; font-weight:700">${b.nom_modele}</span>
                        </div>
                    `).join('');
        } else {
          listContainer.innerHTML = '<div style="padding:40px; text-align:center; color:#999">Vous n\'avez pas encore enregistr√© de babyfoot.</div>';
        }
      } catch (err) {
        listContainer.innerHTML = '<div style="padding:20px; color:var(--rouge)">Erreur de chargement.</div>';
      }
    }

    document.getElementById('btnLogout').onclick = () => {
      if (confirm("Voulez-vous vous d√©connecter ?")) {
        localStorage.removeItem('mybaby_user');
        window.location.hash = '#home';
      }
    };

    // Redirect Add Babyfoot to Map for better UX/Positioning
    document.getElementById('btnAddBabyfoot').onclick = () => {
      alert("Pour une g√©olocalisation pr√©cise, l'ajout se fait directement via la carte. Cliquez sur le bouton '+' de la carte puis sur l'emplacement exact.");
      window.location.hash = '#map';
    };

    await loadProfile();
    await loadMyBabyfoots();
  })();
</script>
