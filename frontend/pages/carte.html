<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="pages/carte.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<div class="map-container">
  <aside class="side-panel" id="sidePanel">
    <button class="drawer-handle" id="drawerHandle" aria-label="D√©plier la liste">
      <span></span>
    </button>
    <div class="side-header">
      <h2 style="margin:0; font-weight:800; color:var(--rouge)">üìç Lieux Proches</h2>
      <div id="activeFilter" style="font-size:0.8rem; color:#666; margin-top:4px">Tous les arrondissements</div>
    </div>
    <div id="lieuxList" class="lieux-list">
      <div class="loader-sm">Chargement...</div>
    </div>
  </aside>

  <div class="map-wrap">
    <div id="map" aria-label="Carte des babyfoots"></div>
    <div class="legend" id="mapLegend">
      <strong>L√©gende</strong>
      <div class="legend-item">
        <img src="assets/icones/loc_point.svg" style="width:18px; height:auto">
        <span>Babyfoot</span>
      </div>
      <div class="legend-item">
        <div style="width:14px; height:2px; background:#BC1515; border:1px dashed #BC1515"></div>
        <span>Arrondissement</span>
      </div>
      <div class="legend-item">
        <img src="assets/icones/raiway_station_4329-1655540952.png" style="width:18px; height:18px">
        <span>Station Ferr√©e</span>
      </div>
    </div>
    <div class="controls">
      <div id="selectWrapper" class="ctrl-group"></div>
      <button id="btnAdd" class="ctrl-btn" title="Ajouter un lieu">Ôºã Ajouter</button>
    </div>
  </div>
</div>

<div class="logo-bottom-left" aria-hidden="true">
  <img src="assets/icones/logo_detaille.svg" alt="MyBaby Logo" style="width: 80px; height: auto;">
</div>

<script type="module">
  import { babyfootService } from './services/babyfootService.js';
  import { mapService } from './services/mapService.js';

  (async function () {
    'use strict';
    if (typeof L === 'undefined') return;

    const map = L.map('map', { zoomControl: false }).setView([48.8566, 2.3522], 12);
    window.map = map;
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const cartoDB = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', { maxZoom: 20 }).addTo(map);
    
    window.babyfootIconNormal = L.icon({ iconUrl: 'assets/icones/loc_point.svg', iconSize: [28, 38], iconAnchor: [14, 38], popupAnchor: [0, -38] });
    window.babyfootIconSelected = L.icon({ iconUrl: 'assets/icones/loc_point_select.svg', iconSize: [36, 48], iconAnchor: [18, 48], popupAnchor: [0, -48] });
    const stationIcon = L.icon({ iconUrl: 'assets/icones/raiway_station_4329-1655540952.png', iconSize: [12, 12], iconAnchor: [6, 12] });

    let stationsGeoJSON = null, arrondissementsGeoJSON = null, allLieux = [];
    const markerGroup = L.layerGroup().addTo(map), stationGroup = L.layerGroup().addTo(map);
    const ardtLayer = L.geoJSON(null, { style: { color: '#BC1515', weight: 3, fillOpacity: 0.05, dashArray: '5, 5' } }).addTo(map);

    window.selectLieu = (id) => {
      if (window.currentSelectedLieuId && window.markers[window.currentSelectedLieuId]) window.markers[window.currentSelectedLieuId].setIcon(window.babyfootIconNormal);
      if (window.markers[id]) {
        window.markers[id].setIcon(window.babyfootIconSelected);
        window.markers[id].openPopup();
        map.setView(window.markers[id].getLatLng(), 17);
        window.currentSelectedLieuId = id;
      }
    };

    async function initLayers() {
      try {
        // 1. Charger les arrondissements et cr√©er les filtres
        arrondissementsGeoJSON = await mapService.getArrondissements();
        if (arrondissementsGeoJSON?.features) {
          ardtLayer.addData(arrondissementsGeoJSON);
          createFilterInterface();
        }

        // 2. Charger les stations
        stationsGeoJSON = await mapService.getStations();
        if (stationsGeoJSON?.features) {
          L.geoJSON(stationsGeoJSON, { pointToLayer: (f, l) => L.marker(l, { icon: stationIcon }) }).addTo(stationGroup);
        }
      } catch (err) { console.error("Erreur initLayers:", err); }
      loadLieux();
    }

    function createFilterInterface() {
      const wrapper = document.getElementById('selectWrapper');
      wrapper.innerHTML = ''; // Nettoyer

      // Filtre Arrondissement
     // --- LOGIQUE DE FILTRAGE SPATIAL ---
      if (filterArdtVal && arrondissementsGeoJSON) {
          // 1. Trouver l'arrondissement s√©lectionn√©
          const ar = arrondissementsGeoJSON.features.find(f => {
              const p = f.properties;
              // On compare avec toutes les cl√©s possibles pour √™tre s√ªr
              return (p.c_ar || p.nom || p.objectid || p.l_ar).toString() === filterArdtVal.toString();
          });
      
          if (ar) {
              labelEl.textContent = ar.properties.nom || ar.properties.l_ar || "Zone filtr√©e";
              
              filtered = filtered.filter(l => {
                  const x = parseFloat(l.xcoord);
                  const y = parseFloat(l.ycoord);
                  
                  if (isNaN(x) || isNaN(y)) return false;
      
                  try {
                      // Cr√©ation de points et polygones valides pour Turf
                      const pt = turf.point([x, y]);
                      // On s'assure que 'ar' est un polygone valide
                      return turf.booleanPointInPolygon(pt, ar);
                  } catch (e) {
                      console.error("Erreur de calcul spatial Turf:", e);
                      return false;
                  }
              });
      
              // Zoom automatique sur l'arrondissement
              const tempLayer = L.geoJSON(ar);
              map.fitBounds(tempLayer.getBounds(), { padding: [30, 30] });
          }
      } else {
          labelEl.textContent = "Tous les arrondissements";
      }
      // Filtre Prix
      const selPrice = document.createElement('select');
      selPrice.id = "filterPrice";
      selPrice.className = "ctrl-btn";
      selPrice.innerHTML = `
        <option value="">Prix Max</option>
        <option value="0">Gratuit</option>
        <option value="0.5">0.50 ‚Ç¨</option>
        <option value="1">1.00 ‚Ç¨</option>
        <option value="2">2.00 ‚Ç¨</option>`;
      selPrice.onchange = () => loadLieux();

      wrapper.append(selArdt, selPrice);
    }

    async function loadLieux() {
      try {
        if (allLieux.length === 0) allLieux = await babyfootService.getAllBabyfoots();
        markerGroup.clearLayers();
        window.markers = {};
        
        const filterArdtVal = document.getElementById('filterArdt')?.value;
        const filterPriceVal = document.getElementById('filterPrice')?.value;
        const labelEl = document.getElementById('activeFilter');

        let filtered = allLieux;

        // FILTRE ARRONDISSEMENT
        if (filterArdtVal && arrondissementsGeoJSON) {
          const ar = arrondissementsGeoJSON.features.find(f => 
            (f.properties.c_ar || f.properties.nom || f.properties.objectid).toString() === filterArdtVal
          );
          if (ar) {
            labelEl.textContent = ar.properties.nom || "Zone filtr√©e";
            filtered = filtered.filter(l => {
              const pt = turf.point([parseFloat(l.xcoord), parseFloat(l.ycoord)]);
              return turf.booleanPointInPolygon(pt, ar);
            });
            map.fitBounds(L.geoJSON(ar).getBounds(), { padding: [30, 30] });
          }
        } else {
          labelEl.textContent = "Tous les arrondissements";
        }

        // FILTRE PRIX
        if (filterPriceVal !== "" && filterPriceVal !== undefined) {
          const maxP = parseFloat(filterPriceVal);
          filtered = filtered.filter(l => {
            const p = l.prix?.toString().toLowerCase() || "";
            if (p.includes("gratuit") || p === "0") return 0 <= maxP;
            const pVal = parseFloat(p.replace(/[^\d.]/g, ''));
            return !isNaN(pVal) && pVal <= maxP;
          });
        }

        // MAJ LISTE LATERALE
        document.getElementById('lieuxList').innerHTML = filtered.map(l => `
          <div class="lieu-card" onclick="window.selectLieu('${l.id_lieu}')">
            <div style="font-weight:800; color:var(--rouge)">${l.nom_lieu}</div>
            <div style="font-size:0.8rem; color:#666">${l.adresse || ''}</div>
          </div>`).join('');

        // BOUCLE MARQUEURS
        filtered.forEach(l => {
          const lat = parseFloat(l.ycoord), lng = parseFloat(l.xcoord);
          if (isNaN(lat) || isNaN(lng)) return;

          let sInfo = "", nearestCoords = null;
          if (stationsGeoJSON?.features.length) {
            try {
              const babyPt = turf.point([lng, lat]);
              const nearest = turf.nearestPoint(babyPt, stationsGeoJSON);
              const d = turf.distance(babyPt, nearest, { units: 'meters' }).toFixed(0);
              const p = nearest.properties;
              const sName = p.nom || p.libelle || p.nom_gare || "Station";
              nearestCoords = `${nearest.geometry.coordinates[1]},${nearest.geometry.coordinates[0]}`;
              
              sInfo = `<div style="margin-top:8px; padding:8px; background:#f0f7ff; border-radius:8px; border-left:4px solid #3388ff; font-size:0.8rem">
                  <strong>Station: ${sName}</strong> (${d}m)
                </div>`;
            } catch(e) {}
          }

          const m = L.marker([lat, lng], { icon: window.babyfootIconNormal }).addTo(markerGroup);
          window.markers[l.id_lieu] = m;

          const dest = `${lat},${lng}`;
          m.bindPopup(`
            <div style="min-width:200px">
              <h3 style="color:var(--rouge);margin:0">${l.nom_lieu}</h3>
              <p style="font-size:0.85rem">${l.adresse || ''}</p>
              <div style="margin:8px 0; font-size:0.75rem"><strong>${l.prix || 'Gratuit'}</strong> ‚Ä¢ ${l.nom_modele || 'Standard'}</div>
              ${sInfo}
              <div style="margin-top:12px; display:flex; flex-direction:column; gap:6px">
                <a href="https://www.google.com/maps/dir/?api=1&destination=${dest}" target="_blank" style="text-decoration:none; background:#4285F4; color:white; padding:8px; border-radius:4px; text-align:center; font-size:0.75rem; font-weight:bold">üöó Itin√©raire</a>
                ${nearestCoords ? `<a href="https://www.google.com/maps/dir/?api=1&origin=${nearestCoords}&destination=${dest}&travelmode=walking" target="_blank" style="text-decoration:none; background:#34A853; color:white; padding:8px; border-radius:4px; text-align:center; font-size:0.75rem; font-weight:bold">üö∂ Depuis station</a>` : ''}
              </div>
            </div>`);

          m.on('click', (e) => { L.DomEvent.stopPropagation(e); window.selectLieu(l.id_lieu); });
        });
      } catch (e) { console.error("Erreur loadLieux:", e); }
    }

    document.getElementById('drawerHandle').onclick = () => document.getElementById('sidePanel').classList.toggle('expanded');
    initLayers();
  })();
</script>
